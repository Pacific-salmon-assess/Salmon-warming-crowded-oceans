---
title: "Comparative (re)analysis of spatial and temporal variation in Pacific salmon responses to a warming and more crowded North Pacific Ocean"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
  font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
  font-size: 15px;
  color: Black;
}
</style>
```
```{r setup, include=FALSE}
# libraries and global settings ----
knitr::opts_chunk$set(echo = FALSE, message=FALSE, cache=FALSE, include=TRUE, dpi=300)
options(scipen=1, digits=4)

library(tidyverse)
library(parallel)
library(coda)
library(rjags)
library(codatools) # see: https://github.com/MichaelMalick/r-codatools/
library(loo)
library(rstan)
library(bayesplot)
library(ggplot2)
library(plyr)

source("../functions.R")
bayesplot::bayesplot_theme_set(new = theme_sleek())

# read in data 

sock <- read.csv("../data/sockeye/master_brood_table_covar.csv",
                 stringsAsFactors = FALSE)
sock$Stock <- factor(sock$Stock, levels = unique(sock$Stock))

sock.info <- read.csv("../data/sockeye/master_stock_info.csv",
                      stringsAsFactors = FALSE)
sock.info$Stock <- factor(sock.info$Stock, levels = unique(sock.info$Stock))

## Colour/ shape scales for plotting
col.region <- rev(chroma::qpal(7, luminance = 40)[c(1, 3, 5, 7)])
col.dk <- rev(chroma::qpal(7, luminance = 20)[c(1, 3, 5, 7)])

names(col.region) <- names(col.dk) <- unique(sock.info$ocean_label2)


col.eras <- c("#00b39e", "#b3a100", "#ff80d7", "#4db8ff",
              "#008070", "#6D6200FF", "#BC007FFF", "#0070BDFF",
              "#00332d", "#4d4500", "#4d0034", "#002e4d")
names(col.eras) <- paste0(rep(names(col.region), 3), ".", rep(c("Early", "Middle", "Late"), each=4))

shp.reg <- c(18, 16, 17, 15)
names(shp.reg) <- unique(sock.info$ocean_label2)
```

# Purpose

This document summarizes preliminary results of analyses that seek to quantifying the extent to which salmon productivity is correlated with (a) ocean conditions during early marine life and (b) potential salmon competitors later in marine life, and the degree to which these relationships vary over time and space. More details on motivation for project can be found [here](https://docs.google.com/document/d/10S7fLbRe9TfdlgTrm0hEvXyFVNHW8M8M/edit) and all code to reproduce the analyses in this document is [here](https://github.com/Pacific-salmon-assess/Salmon-warming-crowded-oceans). All findings are preliminary and subject to change.

# Methods

We are fitting four general classes of spawner-recruitment models to characterize relationships between ocean conditions and salmon productivity over time:

1.  Stationary models that estimate a single time invariant relationship between ocean conditions and salmon productivity (e.g., [Connors et al. 2020](https://cdnsciencepub.com/doi/full/10.1139/cjfas-2019-0422))

2.  A-priori change point models that allow relationships to vary among periods that corresponded with observed Northeast Pacific regime shifts in 1976/77 and 1988/89, as well as the onset of the recent marine heat wave period in 2014 (e.g., [Malick 2020](https://onlinelibrary.wiley.com/doi/10.1111/fog.12469))

3.  Random walk models that allow relationships to evolve through time (e.g., [Malick 2020](https://onlinelibrary.wiley.com/doi/10.1111/fog.12469))

4.  Hidden Markov models that allow relationships to vary according to the state (regime) the system is in, where the sequence of states and state specific relationships are estimated using a Hidden Markov Model framework.

Details on model formulation are provided below. These models are fit in a Bayesian estimation framework using Stan and compared using approximate leave-one-out cross validation. Inference will be primarily based on the magnitude, direction, and uncertainty of standardized covariate effects and the degree to which they vary over time and across ocean regions, species, and life histories.

## Data

### Spawner-recruitment

```{r productivity timeseries, fig.width=4, fig.height=8}
prod_dat <- ocean_region_lab(sock)
prod_dat <- stock.plot.lab(prod_dat)

ggplot(prod_dat) + 
  geom_line(aes(x=BY, y=RS_stnd, col=ocean_region_lab)) + 
  facet_grid(rows=vars(stock_lab), switch ="y", scales="free_y", as.table=F) + 
  scale_colour_manual(values=col.region) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.y.left = element_text(angle=0),
        strip.background = element_rect(fill="transparent", colour="transparent"),
        strip.text = element_text(size=7, ),
        panel.spacing.y = unit(0, unit="cm"),
        panel.background = element_rect(fill="white"),
        legend.position = "none") +
  labs(y="", x="Brood Year")

#Need to specify dimensions and resolution of output
# Can i get names to align right?
# Add Region legend?
```

**Figure 1**. Productivity (R/S) time series of all Sockeye stocks included in analyses.

We have been working to update and add to a large collection of time series of spawner (escapement) and total recruitment (catch plus escapement) for all five species of Pacific salmon. Details on the specific timeseries are avaialble [here](https://docs.google.com/spreadsheets/d/1W6bxaIkzlPkQ4PpN7_SKRWMkLrMlfqWK-FywexUstKs/edit#gid=314988634). The spatial and temporal extent of those populations and species that we have fit models to so far are detailed below.

FIGURE: map of sockeye salmon ocean-entry locations.

FIGURE: sparkline/"lie detector" plot of ln(R/S) timeseries

### Covariates

Our analysis is focused on two covariates:

1.  Sea surface temperatures near juvenile salmon ocean-entry points to index regional-scale environmental variability during the first few months in the ocean, which are hypothesized to represent a critical period in the Pacific salmon life cycle that can strongly influence year class strength.

2.  The abundance of sockeye, chum, and pink salmon across the North Pacific in the second and/or third years of marine life as an index of potential direct or indirect competition for food. This approach is consistent with research that has suggested some salmon species primarily exhibit responses to competition with other salmon during their second and/or third growing seasons at sea ([Connors et al. 2020](https://cdnsciencepub.com/doi/full/10.1139/cjfas-2019-0422); [Ruggerone and Connors 2015](https://cdnsciencepub.com/doi/full/10.1139/cjfas-2014-0134)).

```{r map w/ covariates, fig.width=6, fig.height=7}

# Downlad map and convert to sp
cl <- rnaturalearth::ne_states(country = c("United States of America", "Canada"))
na_map <- sf::st_as_sf(cl)

axes <- list( xlims=c(-165.5, -121), 
              ylims=c(47, 61),
              xbreaks=seq(-160,-120,10), 
              xlabels=as.character(seq(-160,-120,10)),
              seq(45, 65, 5), 
              ybreaks=seq(50, 60, 5),
              ylabels=as.character(seq(50,60,5)))
  
#make map data
map.info <- sock.info %>% select(Stock, lon, lat, ocean_label2) %>% 
  mutate(stock.no = 1:nrow(sock.info)) %>% 
  dplyr::summarize(n.stk = n_distinct(Stock),
                   first.stk = first(stock.no),
                   last.stk = last(stock.no),
                   .by= c("lat", "lon", "ocean_label2")) %>%
  filter(!(first.stk %in% c(54:56))) # remove some overlapping points
map.info$first.stk[map.info$first.stk %in% c(52, 53)] <- 52
map.info$last.stk[map.info$last.stk %in% c(52, 53)] <- 56
map.info <- map.info %>% mutate(num = ifelse(first.stk == last.stk, first.stk, paste(first.stk, last.stk, sep="-")))

map <- ggplot(map.info) + 
      geom_sf(data=na_map, color="grey50", fill="white", linewidth=0.1) + 
      ggspatial::geom_spatial_point(aes(x=lon, y=lat, col=ocean_label2, shape=ocean_label2, fill=ocean_label2), 
                         crs=4326, size=3, stroke=1.75, alpha=0.7) +
      #geom_text(aes(x=lon, y=lat, label=num), vjust=1.4, col="gray20", size=3) +
      ggrepel::geom_text_repel(aes(x=lon, y=lat, label=num), col="gray20", size=3, min.segment.length = 0.25, box.padding=0.1) +
      coord_sf(xlim=axes$xlims, ylim=axes$ylims) +
      scale_x_continuous(breaks=axes$xbreaks, labels=axes$xlabels) +
      scale_y_continuous(breaks=axes$ybreaks, labels=axes$ylabels) +
      scale_colour_manual(values=col.region, name="Ocean Region Grouping") + 
      scale_fill_manual(values=col.dk, name="Ocean Region Grouping") + 
      scale_shape_manual(values=c(23, 21, 24, 22), name="Ocean Region Grouping") +
      labs(x="Longitude (°E)", y="Latitude (°N)") +
      theme_bw() + 
      theme(panel.grid = element_blank(),
            plot.title = element_text(hjust=0.5),
            legend.position = c(0.25,0.25)
            )

## Make dataframe of covariate info
covar.dat.st <- sock %>% select(Stock, BY, Ocean.Region2, early_sst_stnd, np_pinks_sec_stnd) %>% pivot_longer(cols=c(early_sst_stnd, np_pinks_sec_stnd), names_to = "covar") %>% mutate(covar_nam = ifelse(covar=="early_sst_stnd", "SST", "Comp"))
covar.dat.st <- ocean_region_lab(covar.dat.st)
covar.dat.reg <- dplyr::summarize(.data=covar.dat.st, mean_covar = mean(value), .by = c("BY", "ocean_region_lab", "covar_nam"))

covar <- ggplot(covar.dat.st) + geom_line(aes(x=BY, y=value, group=Stock, colour=ocean_region_lab), linewidth=0.5, alpha=0.4) +
  geom_line(data=covar.dat.reg, aes(x=BY, y=mean_covar, col=ocean_region_lab), linewidth=1) +
  facet_grid(rows=vars(covar_nam), cols=vars(ocean_region_lab)) +
   scale_colour_manual(values=col.region) +
   theme_sleek() + theme(legend.position="none")

cowplot::plot_grid(map, covar, nrow=2, rel_heights=c(3,2), rel_widths = c(2,2))

 # Change y scales to be actual temperature in degrees, competitor abundance?
 # Get facet labels on the other side

```

***Figure 2***. Sockeye ocean entry locations and associated climate and competitor covariate time series. (a) ....

FIGURE: Multi-panel plots for each covariate (columns covariates, rows regions, faint lines individual stocks, thick line median)

## Stationary models

In the simplest stationary class of models salmon productivity was modelled hierarchically as a function of spawner abundance, early marine ocean conditions, and potential competitor abundance later in marine life:

```{=tex}
\begin{equation}
ln(R_{i,t}/S_{i,t}) = \alpha_{i} - \beta S_{i,t} + \gamma_{k,i,r} X_{k,i,t} + \varepsilon_{i,t}
\end{equation}
```
where $R$ is the total recruitment from population $i$ and spawners $S$ in brood year $t$, $\alpha$ is productivity (intrinsic rate of growth), $\beta$ is the magnitude of within brood-year density-dependent effects on survival, $\gamma$ is the effect of covariate $k$, $X$ is the specific covariate standardized to mean 0 and standard deviation of 1, and $\epsilon$ is inter-annual variation in survival from egg to adulthood which was assumed to follow a first-order autocorrelated process:

```{=tex}
\begin{equation}
\varepsilon_{i,t}=\phi \varepsilon_{i,t-1} + \sqrt{1-\phi^2 }\delta_{i,t}  \\ \delta_{i,t}\sim N(0,\sigma_{i}^2)
\end{equation}
```
where $\phi$ is the autocorrelation coefficient, and $\delta$ represents uncorrelated, white noise, interannual variation in survival.

The population-specific parameters $\gamma_{k,i,r}$ were modelled hierarchically by assuming they arise from common hyper-distributions: \begin{equation}
\gamma_{k,i,r}\sim N(\mu_{\gamma,k,r},\sigma_{\gamma,k,r}^2)
\end{equation}

where $r$ is one of four broad ocean regions within which salmon populations have previously been shown to exhibit similar responses to ocean climate and ecosystem variation and $\mu$ is the region level average effect.

For Fraser River sockeye stocks (No. 1-19 in Fig. 1), spawner abundances were in units of effective female spawners (i.e., female spawner abundance adjusted for unspawned eggs), whereas for all other stocks spawner abundances were total male and female spawners. Thus, $\alpha_{i}$ parameters were split into two groups (one group that included Fraser River stocks and another group that included all non-Fraser River stocks) that were exchangeable within each group but not between the two groups.

## Era models

The first class of non-stationary model we considered allowed the $\gamma_{k,i,r,e}$ parameters to change at predefined points in time corresponding with well documented Northeast Pacific regime shifts in 1976/77 and 1989/99 ([Hare and Mantua, 2000](https://www.sciencedirect.com/science/article/pii/S0079661100000331)) resulting in three eras ($e$). As with the stationary models we assumed the era specific climate and ecosystem parameters were exchangeable among populations within the same ocean ecosystem and era thereby estimating both population specific and ocean ecosystem level effects by era.

## Random walk models

The second class of non-stationary models we considered allowed the climate and ecosystem parameters to evolve over time according to a random walk: \begin{equation}
\gamma_{k,i,t}=\gamma_{k,i,t-1}+w_{k,t}\\ w_{k,t}\sim N(0,\sigma_{w_{k}}^2)
\end{equation} where $w$ is process variation and $\sigma_{w}^2$ determines the degree if temporal variability in the $\gamma$ series. For these models the covariate effects were  modelled independently instead of being exchangeable among populations within regions (i.e., hierarchically).

## Hidden Markov models

The last class of non-statioanry models combines elements of both the Era and Random walk models by estimating discrete climate and ecosystem effects $\gamma_{k,i,q}$ dictated by regime state using a hidden Markov model approach. The estimated time-series of hidden regime states $z_{t}$ emerges from the evidence from observations $y_{t}$ and is modelled as a Markov process - ie. the year-to-year regime states depend only on the state in the previous time-step ($p(z_{t}|z_{t-1})$) according to an estimated transition probability matrix. The hidden Markov model approach is conceptually similar to the Random walk, but where the coefficient effects are pooled into discrete ordered distributions (ie. low or high estimates in 2 states) with the subsequent probability of being in each state is evaluated at each time-step. In contrast to the Era model, the hidden regime states through time are inferred from the data rather than set a priori (ie. the regimes are 'unsupervised'). The model is evaluated based on the joint likelihood of the observations given each regime $p(y_{1:T}|z_{1:T})$ and the regime sequence $p(z_{1:T})$.

## Model fitting
We fit the model described above in a Bayesian estimation framework with Stan [Stan Development Team 2020](https://mc-stan.org/), which implements the No-U-Turn Hamiltonian Markov chain Monte Carlo algorithm [Hoffman et al. 2014](https://www.jmlr.org/papers/volume15/hoffman14a/hoffman14a.pdf) for Bayesian statistical inference to generate the joint posterior probability distribution of all unknowns in the model. For each  model run, we sampled from 4 chains with 4,000 iterations each and discarded the first 1,000 as warm-up. We assessed chain convergence visually via trace plots and posterior predictive checks and by ensuring that $\hat{R}$ [potential scale reduction factor; [Vehtari et al. 2021](https://projecteuclid.org/journals/bayesian-analysis/volume-16/issue-2/Rank-Normalization-Folding-and-Localization--An-Improved-R%CB%86-for/10.1214/20-BA1221.full)] was less than 1.01 and that the effective sample size was greater than 400 for each parameter in the model. 

# Results

## Stationary models

```{r stationary models: posterior probability dist., fig.align = "center", out.height='88%', out.width = '80%'}
# code to generate figures...

load("../output/models/stat/stat_a.Rdata")

## Fig: Posterior percent change density ------------------- 
lst <- hb05_density_df(stat_a, ocean.regions = 4)
s.df <- lst$stock
m.df <- lst$region
m.df$region <- factor(m.df$region, levels = c("West Coast", "Gulf of Alaska", "Southeast Alaska", "Bering Sea"))

## Covariate labels
vars <- data.frame(var = levels(m.df$var))
vars$lab <- paste0("(", letters[1:nrow(vars)], ") ", vars$var)
vars$var <- factor(vars$var, levels = c("SST", "Comp", "SST + Comp"))

ggplot(m.df) +
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_path(data = s.df[s.df$region == "West Coast", ],
            aes(x = x, y = y, group = stock), color = col.region[["West Coast"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Southeast Alaska", ],
            aes(x = x, y = y, group = stock), color = col.region[["Southeast Alaska"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Gulf of Alaska", ],
            aes(x = x, y = y, group = stock), color = col.region[["Gulf of Alaska"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Bering Sea", ],
            aes(x = x, y = y, group = stock), color = col.region[["Bering Sea"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(aes(x = x, y = y, color = region), linewidth = 1, alpha=1, 
            na.rm = TRUE) +
  scale_colour_manual(name = "Ocean Region", values=col.region, guide="legend") +
  labs(x = "Percent change in R/S",
       y = "Posterior density",
       color = "") +
  scale_x_continuous(limits = c(-50, 50), expand = c(0, 0)) +
  scale_y_continuous(breaks=NULL) +
  geom_text(data = vars,
            aes(x = -48.1,
                y = max(m.df$y) - 0.008,
                label = lab),
            hjust = 0,
            size = 2.7,
            color = "grey30") +
  facet_wrap( ~ var, ncol = 1) +
  theme_sleek(base_size = 9) +
  theme(legend.justification = c(0, 0),
        legend.position = c(0.83, 0.4),
        legend.key.size = unit(10, "pt"),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        panel.spacing.y = unit(-0.5, "pt"),
        strip.background = element_blank(),
        strip.text.x = element_blank())

```

**Figure 3**. Posterior probability distributions of the predicted effect of (a) SST, (b) competitors, and (c) the combined effect from all covariate terms, on sockeye salmon survival. Overall hyperdistribution of the covariate effects are in bold lines, with individual stock-specific distributions illustrated by the light lines. Covariate effects are standardized (i.e., per standard deviation unit increase in each covariate),

```{r stationary models: caterpillar plot}
gamma.stock <- hb_param_df(stat_a, "gamma", "Ocean.Region2", "SST")
kappa.stock <- hb_param_df(stat_a, "kappa", "Ocean.Region2", "Comp")
df.dot <- rbind(gamma.stock, kappa.stock ) # , chi.stock)
df.dot <- ocean_region_lab(df.dot, "region", FALSE)
df.dot$Stock <- factor(df.dot$Stock, levels = levels(sock$Stock))
df.dot$var <- factor(df.dot$var, levels = c("SST", "Comp" )) # ,"SST x Comp"))
df.mu <- plyr::ddply(df.dot, .(region, var), summarize,
                     mu_mean = unique(mu_mean),
                     mu_2.5 = unique(`mu_2.5%`),
                     mu_97.5 = unique(`mu_97.5%`),
                     ocean_region_lab = unique(ocean_region_lab),
                     ystart = Stock[1],
                     yend = Stock[length(Stock)])

ggplot(df.dot) +
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_point(aes(x = mean, y = Stock, color = ocean_region_lab, shape = ocean_region_lab)) +
  geom_segment(aes(y = Stock, yend = Stock, x = `2.5%`, xend = `97.5%`,
                   color = ocean_region_lab), linewidth = 0.25) +
  geom_segment(data = df.mu, aes(y = ystart, yend = yend, x = mu_mean, xend = mu_mean,
                                 color = ocean_region_lab), linewidth = 0.25) +
  geom_rect(data = df.mu, aes(xmin = mu_2.5, xmax = mu_97.5, ymin = ystart,
                              ymax = yend, fill = ocean_region_lab),
            alpha = 0.2) +
  scale_colour_manual(name = "Ocean Region", values=col.region, guide="legend") +
  scale_shape_manual(name = "Ocean Region", values = shp.reg, guide="legend") +
  scale_fill_manual(values = col.region, guide="none") +
  labs(x = "Coefficient",
       y = "",
       color = "",
       shape = "") +
  facet_wrap( ~ var) +
  scale_x_continuous(breaks=c(-0.25,0,0.25))+
  theme_sleek(base_size = 10) +
  theme(legend.justification = c(0, 0),
        legend.position = c(0.01, 0.78),
        legend.key.size = unit(10, "pt"),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        panel.spacing.x = unit(-0.5, "pt"))

```

**Figure 4** -- figure caption -- FIGURE: Caterpillar plot (stock specific and regional posteriors by covariate, stocks as rows)

## A-priori models

FIGURE: Time period covariate coefficient regional posteriors grouped by covariate

```{r Apriori models: density plot}

## Load era model fit
load("../output/models/dyn/hbm_era_2c.Rdata")

## Data
# Density dataframe - by stock
dens.df.st.2c <- era_density_df(era.2c, par=c("gamma", "kappa"), percent.change = T)
dens.df.st.2c <- ocean_region_lab(dens.df.st.2c)
# Density dataframe (regional lvl)
dens.df.reg.2c <- era_density_df(era.2c, par=c("gamma", "kappa"), mu=T, percent.change=T)
dens.df.reg.2c <- ocean_region_lab(dens.df.reg.2c)


## Figures
ggplot(dens.df.st.2c) + 
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_path(aes(x=x, y=dens, group=stock, col=ocean_region_lab), alpha=0.2) + 
  geom_path(data=dens.df.reg.2c, aes(x=x, y=dens, col=ocean_region_lab), alpha=0.85, linewidth=1) +
  scale_colour_manual(values=col.region) +
  facet_grid(rows=vars(era), cols=vars(factor(varnam, levels=c("SST", "Competitors")))) + 
  coord_cartesian(xlim=c(-50,50)) +
  theme_sleek() + labs(x="Covariate effect", y="", col="Ocean Region") +
  theme(axis.text.y=element_blank(),
        legend.key.size = unit(10, "pt"),
        legend.position=c(0.9, 0.2),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        legend.title = element_text(size=9),
        panel.spacing.y = unit(-0.5, "pt"),
        axis.ticks.y=element_blank()) 


## Notes: Include years with early/middle/late
## match x axis with stationary model: % change in ln R/S
```

FIGURE: Time period covariate coefficient posteriors grouped by region and covariate, stacked by stock

```{r Apriori models: caterpillar plot}

# wrangle dataframes
df.era.st.2c <- era_hb_param_df(era.2c, par=c("gamma", "kappa"))
df.era.st.2c <- ocean_region_lab(df.era.st.2c)
df.era.reg.2c <- era_hb_param_df(era.2c, par=c("gamma", "kappa"), mu = TRUE)
df.era.reg.2c <- ocean_region_lab(df.era.reg.2c)


ggplot(df.era.st.2c) +
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_point(aes(x = mu, y = Stock, color = interaction(ocean_region_lab, era), shape = ocean_region_lab), size=1.2) +
  geom_segment(data = df.era.reg.2c, aes(y = ystart, yend = yend, x = reg_mean, xend=reg_mean,
                                           color = interaction(ocean_region_lab, era)), linewidth = 0.25) +
  geom_rect(data = df.era.reg.2c, aes(xmin = lower_10, xmax = upper_90, ymin = ystart,
                                        ymax = yend, fill = interaction(ocean_region_lab, era)), alpha=0.15) +
  facet_wrap(vars(factor(varnam, levels=c("SST", "Competitors"))), ncol=2, scales="free_x") +
  scale_colour_manual(name = "Ocean Region", values=col.eras) +
  scale_shape_manual(name = "Ocean Region", values=shp.reg, guide="legend") +
  scale_fill_manual(values=col.eras) +
  labs(x = "Coefficient",
       y = "",
       color = "",
       shape = "") +
  scale_x_continuous(breaks=c(-0.25,0,0.25))+
  theme_sleek(base_size = 10) +
  theme(legend.position = "none", 
        legend.justification = c(0, 0),
        legend.key.size = unit(10, "pt"),
        legend.background = element_blank(),
        legend.text = element_text(size = 8)
  )


## Notes: make a legend, abbreviated stock names?
# Can I get it to generate in higher definition so the points aren't all weird?
```

## Random walk models

FIGURE: Time series of covariate coefficient posteriors (mean across stocks in bold, faint lines for individual stocks) grouped by region and covariate

FIGURE: "sparkline plots" (like above but with time series of posteriors, stocks as rows) -- Decided not to include sparkline plots --

```{r random walk models: figures, warning=FALSE}
#Data
# Load model fit
load(file="../output/models/dyn/hbm_dyn_2c.Rdata")

# Stock specific dataframe
probs <- c(0.025, 0.05, 0.10, 0.50, 0.90, 0.95, 0.975)
summ <- rstan::summary(dyn.2c, pars = c("gamma", "kappa"), probs = probs)$summary
df.dyn.st.2c <- data.frame(Stock = sock$Stock,
                   Ocean.Region2 = sock$Ocean.Region2,
                   BY = sock$BY,
                   mu = summ[, "mean"],
                   se = summ[, "se_mean"],
                   lower_10 = summ[, "10%"],
                   upper_90 = summ[ , "90%"],
                   var = str_extract(rownames(summ), "[a-z]+"),
                   varnam = case_when(grepl("^gamma", rownames(summ)) ~ "SST",
                                      grepl("^kappa", rownames(summ)) ~ "Competitors")
                   )
df.dyn.st.2c <- ocean_region_lab(df.dyn.st.2c)

# Summarize at regional lvl
df.dyn.reg.2c <- dplyr::summarize(df.dyn.st.2c, 
                           reg_mean=mean(mu, na.rm=T), 
                           n_stk=n_distinct(Stock),
                           lower_10=quantile(mu, 0.1), 
                           upper_90=quantile(mu, 0.9), 
                           .by=c(Ocean.Region2, BY, varnam))
df.dyn.reg.2c <- ddply(df.dyn.reg.2c, .(Ocean.Region2), dplyr::filter, n_stk >= max(n_stk)*0.1)
df.dyn.reg.2c <- ocean_region_lab(df.dyn.reg.2c)


# Figures
ggplot(df.dyn.reg.2c) +
  geom_hline(yintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +  
  geom_line(data= df.dyn.st.2c, aes(x=BY, y=mu, group=Stock, col=ocean_region_lab), alpha=0.2) +
  geom_line(aes(x=BY, y=reg_mean, col=ocean_region_lab), linewidth=1) +
  geom_ribbon(aes(x=BY, y=reg_mean, ymin=lower_10, ymax=upper_90, fill=ocean_region_lab), alpha=0.2) +
  facet_grid(cols=vars(ocean_region_lab), rows=vars(factor(varnam, levels=c("SST", "Competitors"))), scales="free_y") + 
  ylim(c(-0.75,0.75)) + 
  scale_colour_manual(values=col.region, aesthetics=c("colour", "fill")) +
  theme_sleek() + theme(legend.position="none") +
   labs(x="Brood Year", y="Posterior mean coeffiicents")


## try moving average to smooth
## order regions correctly

```

## Hidden Markov models

FIGURE: Gamma timeseries grouped by region (mean across stocks in bold)

FIGURE: Realized coefficients and state coefficients (both as caterpillar-ish plots)

FIGURE: 2 state plots - add measure of uncertainty (density hist or box and whiskers)

```{r hmm timeseries}
# Load fit summary
load("../output/hmm_ac_out_2c.Rdata")

#Data 
stk.summ.df <- hmm_param_df(hmm_ac_out_2c, summary="stock")
stk.summ.df <- ocean_region_lab(stk.summ.df, var="region")
reg.summ.df <- hmm_param_df(hmm_ac_out_2c, summary="region")
reg.summ.df <- ocean_region_lab(reg.summ.df, var="region")

ggplot(reg.summ.df) + 
  geom_hline(yintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_line(data=stk.summ.df, aes(x=BY, y=realb_mu, group=Stock, col=ocean_region_lab), alpha=0.2) +
  geom_line(aes(x=BY, y=realb_mu, col=ocean_region_lab), linewidth=1) +
  geom_ribbon(aes(x=BY, ymin=realb_10, ymax=realb_90, fill=ocean_region_lab), alpha=0.2) +
  facet_grid(cols=vars(ocean_region_lab), rows=vars(factor(beta_covar, levels=c("SST", "Competitors"))), scales="free_y") +
  scale_colour_manual(values=col.region, aesthetics = c("colour", "fill")) +
  theme_sleek() + theme(legend.position="none", 
                          axis.text.x = element_blank()) +
  labs(x="Brood Year", y="Posterior mean coeffiicents")


```

```{r hmm state coefficients, fig.width=6, fig.height=7}
# Data
post.df <- hmm_param_df(hmm_ac_out_2c, summary="none")
post.df <- ocean_region_lab(post.df, var="region")
p.post.df <- unique(select(.data=post.df, Stock, ocean_region_lab, contains("beta")))
p.post.df <- stock.plot.lab(p.post.df, numbered=F)

# Dot and whiskers
ggplot(p.post.df) + 
  geom_point(aes(x=beta_mu, y=stock_lab, col=ocean_region_lab), shape="\u007C", size=2) +
  geom_segment(aes(x=beta_2.5, xend=beta_97.5, y=stock_lab, yend=stock_lab, col=ocean_region_lab)) +
  geom_segment(aes(x=beta_10, xend=beta_90, y=stock_lab, yend=stock_lab, col=ocean_region_lab), linewidth=3.5, alpha=0.2) +
  facet_wrap(vars(factor(beta_covar, levels=c("SST", "Competitors")))) + 
  scale_colour_manual(values=col.region) + theme_sleek() + theme(legend.position="none") +
  labs(x="State coefficient posterior", y="")
```

# Next steps

-   Explore alternative temporal and spatial domains over which to average SST anomalies to derive the early ocean temperature covariate

-   Update sockeye, pink, and chum spawner-recruitment time-series based on data from ADF&G and DFO

-   Incorporate Chinook and coho spawner-recruitment time series into analysis
