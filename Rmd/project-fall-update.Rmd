---
title: "Comparative (re)analysis of spatial and temporal variation in Pacific salmon responses to a warming and more crowded North Pacific Ocean"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
  font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
  font-size: 15px;
  color: Black;
}
</style>
```
```{r setup, include=FALSE}
# libraries and global settings ----
knitr::opts_chunk$set(echo = FALSE, message=FALSE, cache=FALSE, include=TRUE, dpi=300)
options(scipen=1, digits=4)

library(tidyverse)
library(parallel)
library(coda)
library(rjags)
library(codatools) # see: https://github.com/MichaelMalick/r-codatools/
library(loo)
library(rstan)
library(bayesplot)
library(ggplot2)
library(plyr)

source("../functions.R")
bayesplot::bayesplot_theme_set(new = theme_sleek())

# read in data 

sock <- read.csv("../data/master_brood_table_covar.csv",
                 stringsAsFactors = FALSE)
sock$Stock <- factor(sock$Stock, levels = unique(sock$Stock))

sock.info <- read.csv("../data/master_stock_info.csv",
                      stringsAsFactors = FALSE)
sock.info$Stock <- factor(sock.info$Stock, levels = unique(sock.info$Stock))

```

# Purpose

This document summarizes preliminary results of analyses that seek to quantifying the extent to which salmon productivity is correlated with (a) ocean conditions during early marine life and (b) potential salmon competitors later in marine life, and the degree to which these relationships vary over time and space. More details on motivation for project can be found [here](https://docs.google.com/document/d/10S7fLbRe9TfdlgTrm0hEvXyFVNHW8M8M/edit) and all code to reproduce the analyses in this document is [here](https://github.com/Pacific-salmon-assess/Salmon-warming-crowded-oceans). All findings are preliminary and subject to change.

# Methods

We are fitting four general classes of spawner-recruitment models to characterize relationships between ocean conditions and salmon productivity over time:

1.  Stationary models that estimate a single time invariant relationship between ocean conditions and salmon productivity (e.g., [Connors et al. 2020](https://cdnsciencepub.com/doi/full/10.1139/cjfas-2019-0422))

2.  A-priori change point models that allow relationships to vary among periods that corresponded with observed Northeast Pacific regime shifts in 1976/77 and 1988/89, as well as the onset of the recent marine heat wave period in 2014 (e.g., [Malick 2020](https://onlinelibrary.wiley.com/doi/10.1111/fog.12469))

3.  Random walk models that allow relationships to evolve through time (e.g., [Malick 2020](https://onlinelibrary.wiley.com/doi/10.1111/fog.12469))

4.  Hidden Markov models that allow relationships to vary according to the state (regime) the system is in, where the sequence of states and state specific relationships are estimated using a Hidden Markov Model framework.

Details on model formulation are provided below. These models are fit in a Bayesian estimation framework using Stan and compared using approximate leave-one-out cross validation. Inference will be primarily based on the magnitude, direction, and uncertainty of standardized covariate effects and the degree to which they vary over time and across ocean regions, species, and life histories.

## Data

### Spawner-recruitment

FIGURE: sparkline/"lie detector" plot of ln(R/S) timeseries

### Covariates

Our analysis is focused on two covariates:

1.  Sea surface temperatures near juvenile salmon ocean-entry points to index regional-scale environmental variability during the first few months in the ocean, which are hypothesized to represent a critical period in the Pacific salmon life cycle that can strongly influence year class strength.

2.  The abundance of sockeye, chum, and pink salmon across the North Pacific in the second and/or third years of marine life as an index of potential direct or indirect competition for food. This approach is consistent with research that has suggested some salmon species primarily exhibit responses to competition with other salmon during their second and/or third growing seasons at sea ([Connors et al. 2020](https://cdnsciencepub.com/doi/full/10.1139/cjfas-2019-0422); [Ruggerone and Connors 2015](https://cdnsciencepub.com/doi/full/10.1139/cjfas-2014-0134)).

FIGURE: Multi-panel plots for each covariate (columns covariates, rows regions, faint lines individual stocks, thick line median)

## Stationary models

## A-priori models

## Randaom walk models

## Hidden Markov models

# Results

## Stationary models

```{r stationary models, caption = "Blah"}
# code to generate figures...

load("../output/models/stat/stat_a.Rdata")

col.region <- chroma::qpal(7, luminance = 40)[c(1, 3, 5, 7)]

## Fig: Posterior percent change density ------------------- 
lst <- hb05_density_df(stat_a, ocean.regions = 4)
s.df <- lst$stock
m.df <- lst$region
m.df$region <- factor(m.df$region, levels = c("West Coast", "Gulf of Alaska", "Southeast Alaska", "Bering Sea"))

## Covariate labels
vars <- data.frame(var = levels(m.df$var))
vars$lab <- paste0("(", letters[1:nrow(vars)], ") ", vars$var)
vars$var <- factor(vars$var, levels = c("SST", "Comp", "SST + Comp"))

ggplot(m.df) +
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_path(data = s.df[s.df$region == "West Coast", ],
            aes(x = x, y = y, group = stock), color = col.region[1], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Gulf of Alaska", ],
            aes(x = x, y = y, group = stock), color = col.region[2], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Southeast Alaska", ],
            aes(x = x, y = y, group = stock), color = col.region[3], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Bering Sea", ],
            aes(x = x, y = y, group = stock), color = col.region[4], alpha=0.3,
            na.rm = TRUE) +
  geom_path(aes(x = x, y = y, color = region), linewidth = 1, alpha=1, 
            na.rm = TRUE) +
  scale_color_manual(values = col.region) +
  labs(x = "Percent change in R/S",
       y = "Posterior density",
       color = "") +
  scale_x_continuous(limits = c(-50, 50), expand = c(0, 0)) +
  scale_y_continuous(breaks=NULL) +
  geom_text(data = vars,
            aes(x = -48.1,
                y = max(m.df$y) - 0.008,
                label = lab),
            hjust = 0,
            size = 2.7,
            color = "grey30") +
  facet_wrap( ~ var, ncol = 1) +
  theme_sleek(base_size = 9) +
  theme(legend.justification = c(0, 0),
        legend.position = c(0.7, 0.85),
        legend.key.size = unit(10, "pt"),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        panel.spacing.y = unit(-0.5, "pt"),
        strip.background = element_blank(),
        strip.text.x = element_blank())

```
**Figure 3**. Posterior probability distributions of the predicted effect of (a) SST, (b) competitors, and (c) the combined effect from all covariate terms, on sockeye salmon survival. Overall hyperdistribution of the covariate effects are in bold lines, with individual stock-specific distributions illustrated by
the light lines. Covariate effects are standardized (i.e., per standard deviation unit increase in each covariate),

FIGURE: Caterpillar plot (stock specific and regional posteriors by covariate, stocks as rows)

## A-priori models

FIGURE: Time period covariate coefficient regional posteriors grouped by covariate

FIGURE: Time period covariate coefficient posteriors grouped by region and covariate, stacked by stock

```{r Apriori models, include=FALSE}
# code to generate figures...
```

## Random walk models

FIGURE: Time series of covariate coefficient posteriors (mean across stocks in bold, faint lines for individual stocks) grouped by region and covariate

FIGURE: "sparkline plots" (like above but with time series of posteriors, stocks as rows)

```{r random walk models, include=FALSE}
# code to generate figures...
```

## Hidden Markov models

FIGURE: Gamma timeseries grouped by region (mean across stocks in bold)

FIGURE: Realized coefficients and state coefficients (both as caterpillar-ish plots)

FIGURE: 2 state plots - add measure of uncertainty (density hist or box and whiskers)

```{r hidden markov models, include=FALSE}
# code to generate figures...
```

# Next steps

-   Explore alternative temporal and spatial domains over which to average SST anomalies to derive the early ocean temperature covariate

-   Update sockeye, pink, and chum spawner-recruitment time-series based on data from ADF&G and DFO

-   Incorporate Chinook and coho spawner-recruitment time series into analysis
