---
title: "Winter Update: comparative (re)analysis of spatial and temporal variation in Pacific salmon responses to a warming and more crowded North Pacific Ocean"
author: "H. Hunter"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:  
  bookdown::html_document2:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
  font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
  font-size: 15px;
  color: Black;
}
</style>
```
```{r setup, include=FALSE}

# global settings
knitr::opts_chunk$set(echo = FALSE, message=FALSE, cache=FALSE, include=TRUE, dpi=300)
options(scipen=1, digits=4)

# functions
source("../functions.R")

# libraries
source("../load.R")
library(plotly)

# read brood table data
sock <- read.csv("../data/sockeye/master_sockeye_brood_table_covar.csv", stringsAsFactors = F)
pink <- read.csv("../data/pink/master_pink_brood_table_covar.csv", stringsAsFactors = F)
chum <- read.csv("../data/chum/master_chum_brood_table_covar.csv", stringsAsFactors = F)
# read info tables
sock.info <- read.csv("../data/sockeye/master_sockeye_stock_info.csv", stringsAsFactors = F)
pink.info <- read.csv("../data/pink/master_pink_stock_info.csv", stringsAsFactors = F)
chum.info <- read.csv("../data/chum/master_chum_stock_info.csv", stringsAsFactors = F)

# subset sockeye stocks
stk.sub <- sock.info$Stock.ID[sock.info$yr_start < 1985 & sock.info$yr_end >= 2014]
sock.sub <- sock %>% filter(Stock.ID %in% stk.sub)
sock.info.sub <- sock.info %>% filter(Stock.ID %in% stk.sub)

# everything crumbles if they aren't ordered factors
sock.sub <- geographic.order(sock.sub)
sock.info.sub <- geographic.order(sock.info.sub)
pink <- geographic.order(pink)
pink.info <- geographic.order(pink.info)
chum <- geographic.order(chum)
chum.info <- geographic.order(chum.info)

# remove the data_master and data_info that functions rely on
rm("data_master")
rm("info_master")


# figure specifications
bayesplot::bayesplot_theme_set(new = theme_sleek())
col.region <- rev(chroma::qpal(7, luminance = 40)[c(1, 3, 5, 7)]) # region colours
col.dk <- rev(chroma::qpal(7, luminance = 20)[c(1, 3, 5, 7)]) # darker region colours
names(col.region) <- names(col.dk) <- unique(sock.info$ocean_region_lab) #name
shp.reg <- c(18, 16, 17, 15) # region shapes
names(shp.reg) <- unique(sock.info$ocean_region_lab) # name
sp.col <- c("seagreen4", "palevioletred3", "orangered4") # species colours 
names(sp.col) <- c("Chum", "Pink", "Sockeye") # name

```

# Purpose

This document summarizes updated methods and results from the analyses origionally described [here](https://pacific-salmon-assess.github.io/Salmon-warming-crowded-oceans/Rmd/project-fall-update.html). Our analysis now includes Pink (n=70) and Chum (n=44) salmon stocks from across the eastern North Pacific, as well as updated data for Sockeye stocks (n = 52), however, Pink and Chum time series from Alaska have not been able to be updated yet.

# Methods

The overarching goal of our analyses is to characterize relationships between ocean conditions (SST and abundance of potential competitors) and salmon productivity (R/S) over space and time. Since our last update, we have made minor changes to our approach, as described in the sections below.

## Data

We have compiled spawner-recruitment time series for all five species of Pacific salmon, which are hosted in a [github repository](https://github.com/Pacific-salmon-assess/dfo_salmon_compilation), although only Sockeye, Pink, and Chum populations are analyzed here. We analyze a total of 166 populations originating from Washington to the Bering Sea:

-   From our original set of 58 Sockeye populations, we obtained more data for the Southeast Alaska and West Coast (BC) regions, but subsequently chose to remove time series that did not span at least 1984-2015 brood years without significant gaps. This is intended to make sure each time series overlaps with all three time periods in our 'era' models, and excludes short series that random walk models may be sensitive to. There are now 52 Sockeye stocks in the analysis - many of the original stocks, and some new ones.

-   We obtained spawner-recruitment time series for Pink and Chum populations, and currently use all time series with reasonable data quality, regardless of whether they meet the criteria applied to Sockeye data. These data are not representative of all regions and time periods, and notably, we have no data after 2009 for any Alaskan stocks. We are working with Andrew Munro (ADF&G) to update these Alaskan timeseries (or some subset of them) through to the present.

-   Compilation of Coho and Chinook time series is on the back burner for now.

### Map of ocean entry points

The map below shows the ocean entry locations of all stocks in the analysis presented. The legend to the right of the plot allows you to toggle between species (double-click a legend item to isolate that species). Hovering over a point will show the stock name and ocean region.

```{r Ocean entry map, out.width="100%", out.height="50%", warning=FALSE}
# specify output size or plotly makes it huge

# Downlad map and convert to sp
na_map <- rnaturalearth::ne_states(country = c("United States of America", "Canada"), returnclass='sf')

axes <- list( xlims=c(-171, -121), 
              ylims=c(46, 67),
              xbreaks=seq(-170,-120,10), 
              xlabels=as.character(seq(-170,-120,10)),
              seq(45, 65, 5), 
              ybreaks=seq(45, 65, 5),
              ylabels=as.character(seq(45,65,5)))

#make map data
sock.info.sub$Species <- "Sockeye"
chum.info$Species <- "Chum"
pink.info$Species <- "Pink"
map.info <- rbind(sock.info.sub, chum.info, pink.info)


map <- ggplot(data = map.info) + 
  geom_sf(data=na_map, color="grey40", fill="white", linewidth=0.1) + 
  ggspatial::geom_spatial_point(aes(x=lon, y=lat, col=Species, shape=Species, group=Stock, text=paste("Region:", ocean_region_lab)), 
                                crs=4326, size=2.5,
                                position=position_jitter(w=0.2, h=0.2)) +
  coord_sf(xlim=axes$xlims, ylim=axes$ylims) +
  scale_x_continuous(breaks=axes$xbreaks, labels=axes$xlabels) +
  scale_y_continuous(breaks=axes$ybreaks, labels=axes$ylabels) +
  scale_colour_manual(values=sp.col) +
  scale_shape_manual(values=c(15,16,17)) +
  labs(x=paste0("Longitude (", "\u00B0", "E)"), y=paste0("Latitude (", "\u00B0", "N)")) +
  theme_sleek() + 
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust=0.5),
        legend.position = c(0.4,0.25),
        legend.background = element_rect(colour="grey75")
  )

ggplotly(map, tooltip=c("group", "text")) %>% config(modeBarButtonsToRemove = 
                                                       c("zoom", "lasso2d", "select2d", 
                                                         "autoscale2d", "hoverClosestCartesian", "hoverCompareCartesian")
                                                     #,scrollZoom = TRUE
                                                     )
#%>% layout(legend=list(x=0.8,y=0.9))

```

**Figure 1**. Ocean entry locations of Sockeye (n=52), Pink (n=70), and Chum (n=44) salmon stocks included in analyses (total N=166).

### Time Series Length {.tabset}

Productivity (log[R/S]) time series of all stocks are shown below to illustrate the length and relative number of time series among regions and species. Vertical dashed lines represent proposed regime shifts in the 'era' model (described in sec. 2.2) to illustrate the coverage of data over periods of interest. Where coloured lines break to light gray, data are missing.

#### Sockeye

```{r Sockeye time series, fig.height=6.5, warning=F}
prod_dat <- fill.time.series(sock.sub)
prod_dat <- ocean_region_lab(prod_dat)
prod_dat <- stock.plot.lab(prod_dat, numbered = F)

ggplot(prod_dat) + 
  geom_vline(xintercept=c(1989,2011), color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_line(data=na.omit(prod_dat), aes(x=BY, y=lnRS), col="grey75") + # if there are any gaps they will show
  geom_line(aes(x=BY, y=lnRS, col=ocean_region_lab)) + 
  facet_grid(rows=vars(stock_lab), switch ="y", scales="free_y", as.table=F) + 
  scale_colour_manual(values=col.region, name="") +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.y.left = element_text(angle=0, hjust=0, margin=margin(l=0, r=0)),
        strip.background = element_rect(fill="transparent", colour="transparent"),
        strip.text = element_text(size=7, ),
        panel.spacing.y = unit(0, unit="cm"),
        panel.background = element_rect(fill="white"),
        legend.position = "right",
        legend.key = element_blank()) +
  guides(colour=guide_legend(reverse=TRUE)) +
  labs(y="", x="Brood Year")


```

**Figure 2**. Productivity (log[R/S]) time series of Sockeye stocks (n=52) with vertical dashed lines indicating proposed ocean regime shifts.

#### Pink

```{r Pink time series, fig.height=7, warning=F}
prod_dat <- fill.time.series(pink)
prod_dat <- ocean_region_lab(prod_dat)
prod_dat <- stock.plot.lab(prod_dat, numbered = F)

ggplot(prod_dat) + 
  geom_vline(xintercept=c(1989,2011), color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_line(data=na.omit(prod_dat), aes(x=BY, y=lnRS), col="grey75") + 
  geom_line(aes(x=BY, y=lnRS, col=ocean_region_lab)) + 
  facet_grid(rows=vars(stock_lab), switch ="y", scales="free_y", as.table=F) + 
  scale_colour_manual(values=col.region, name="") +
  scale_x_continuous(breaks=seq(1950, 2020, 10)) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.y.left = element_text(angle=0, hjust=0, margin=margin(l=0, r=0)),
        strip.background = element_rect(fill="transparent", colour="transparent"),
        strip.text = element_text(size=7, ),
        panel.spacing.y = unit(0, unit="cm"),
        panel.background = element_rect(fill="white"),
        legend.position = "right",
        legend.key = element_blank()) +
  guides(colour=guide_legend(reverse=TRUE)) +
  labs(y="", x="Brood Year")

```

**Figure 3**. Productivity (log[R/S]) time series of Pink stocks (n=70) with vertical dashed lines indicating proposed ocean regime shifts. Note that Even- and Odd-run pinks are considered separately due to their independent and sometimes vastly different productivity regimes.

#### Chum

```{r Chum time series, warning=F}
prod_dat <- fill.time.series(chum)
prod_dat <- ocean_region_lab(prod_dat)
prod_dat <- stock.plot.lab(prod_dat, numbered = F)

ggplot(prod_dat) + 
  geom_vline(xintercept=c(1989,2011), color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_line(data=na.omit(prod_dat), aes(x=BY, y=lnRS), col="grey75") + 
  geom_line(aes(x=BY, y=lnRS, col=ocean_region_lab)) + 
  facet_grid(rows=vars(stock_lab), switch ="y", scales="free_y", as.table=F) + 
  scale_colour_manual(values=col.region, name="") +
  scale_x_continuous(breaks=seq(1950, 2020, 10)) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.y.left = element_text(angle=0, hjust=0, margin=margin(l=0, r=0)),
        strip.background = element_rect(fill="transparent", colour="transparent"),
        strip.text = element_text(size=7, ),
        panel.spacing.y = unit(0, unit="cm"),
        panel.background = element_rect(fill="white"),
        legend.position = "right",
        legend.key = element_blank()) +
  guides(colour=guide_legend(reverse=TRUE)) +
  labs(y="", x="Brood Year")


```

**Figure 4**. Productivity (log[R/S]) time series of Chum stocks (n=44) with vertical dashed lines indicating proposed ocean regime shifts. Note that there are no time series in the Southeast Alaska (SEAK) region; one stock (Middle Skeena) that would have been assigned to SEAK was grouped with West Coast stocks instead.

## Models

Our updated analyses focus on three classes of generalized spawner-recruitment models:

1.  Stationary models (e.g. [Connors et al. 2020](https://cdnsciencepub.com/doi/full/10.1139/cjfas-2019-0422)), which estimate time-invariant relationships. These have not changed since last update other than the addition of data for the two new species.

2.  'Era' models (e.g., [Malick 2020](https://onlinelibrary.wiley.com/doi/10.1111/fog.12469)), which allow relationships to vary among pre-defined periods that represent hypothesized shifts in North Pacific Ocean processes and relationships.

    -   We no longer model 1976/77 as a regime shift per feedback from collaborators at our last update, which highlighted that this shift from a cold to warm PDO phase simply reflected a temperature change (which is already accounted for via our direct consideration of ocean temperature) and not a fundamental change in oceanographic processes like the 1988/89 regime shift.

    -   Our updated analyses consider a potential regime shift at the onset of the \~2013-2015 marine heatwave ('the blob'). Currently, we consider brood years \>= 2011 to have interacted with the marine heatwave regardless of the species and stock. In future analyses, the timing can be altered to better reflect the diverse life histories of populations in the analysis.

3.  Random walk models (e.g., [Malick 2020](https://onlinelibrary.wiley.com/doi/10.1111/fog.12469)), which allow relationships to evolve gradually through time.

    -   These have not changed since last update other than the addition of new data. However, a version that estimates ocean basin-scale trends in relationships (e.g., as shared trends within ocean region that are modeled hierarchically) is currently in initial stages of development.

<!-- -->

(4) At this time we are not pursuing Hidden Markov models, which model the system as having two or more latent states, as our initial analyses indicated they did not add any additional inference beyond those from the era and random walk models. They may be revisited in the future.

Further details on each model class and Bayesian model fitting procedure can be found [here](https://pacific-salmon-assess.github.io/Salmon-warming-crowded-oceans/Rmd/project-fall-update.html#23_Era_models).

# Results

## Overall insights

We see evidence for spatially and temporally varying responses to warming and competition at sea in all three species.

In Sockeye, we continue to see strong evidence for spatial variation in relationships between productivity and both SST and competitor abundance, as has been described previously, as well as variation in relationships within regions over time. For southernmost stocks we see a general strengthening of inverse relationships for both covariates over time. For stocks at intermediate latitudes (SEAK and GoA) we see evidence of relationships with SST flipping over time such that during positive relationships the 'marine heatwave' period they are strongly negative, but positive in earlier periods. For the competitor index we see weak and variable relationships in early and late periods and consistently negative ones in the 1989-2010 period. At the northernmost extent (Bering Sea) we see consistently positive relationships with SST and variable relationships with competitor abundance.

In Pinks, we see clear evidence of spatial variation in SST relationships, consistent with previous work, but less pronounced patterns in ones with competitor abundance. Like in Sockeye, relationships with SST vary latitudinally and for southernmost stocks become more negative over time while for SEAK stocks there is evidence of a flip in relationships from positive to negative by the 'marine heatwave' period. For the competitor index we see positive relationships in the early period which presumably reflects shared positive responses to ocean conditions and then highly uncertain and weak relationships thereafter which is consistent with the hypothesis that Pink salmon are the least affected by intra-specfic competition at sea (Ruggerone and Nielsen, 2005). However, in addition to the short temporal window of the most recent period, many of the time series for mid and northern latitude stocks have not been updated yet.

In Chum, we see a consistently negative relationship with SST in the southernmost (WC) region that becomes more negative over time, while more northern stocks show weakly positive to neutral SST relationships. Chum have relatively weak relationships with competitor abundance compared to Sockeye, but northern (BS) stocks shift from a positive relationship in the first era to weakly negative in the second era in both species. Again, this likely represents a response to favourable ocean conditions experienced by all species in the early period, and negative responses to inter-specific competition in later periods as pink salmon abundance increased. Inference about Chum in the marine heatwave period will also require updating time series for Alaskan stocks.

## Stationary models {.tabset}

### Sockeye

```{r Sockeye stationary}

# Load model fit
load("../output/models/stat/sockeye/stat_sub.Rdata")

# Get data
lst <- hb05_density_df(stat_sub, ocean.regions = 4, info_master=sock.info.sub, data_master=sock.sub)
s.df <- lst$stock
m.df <- lst$region
m.df$region <- factor(m.df$region, levels = c("West Coast", "Gulf of Alaska", "Southeast Alaska", "Bering Sea"))

## Covariate labels
vars <- data.frame(var = levels(m.df$var))
vars$lab <- gsub("Comp", "Competitors", vars$var)
vars$var <- factor(vars$var, levels = c("SST", "Comp", "SST + Comp"))

# I think I could shorten this 
ggplot(m.df) +
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_path(data = s.df[s.df$region == "West Coast", ],
            aes(x = x, y = y, group = stock), color = col.region[["West Coast"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Southeast Alaska", ],
            aes(x = x, y = y, group = stock), color = col.region[["Southeast Alaska"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Gulf of Alaska", ],
            aes(x = x, y = y, group = stock), color = col.region[["Gulf of Alaska"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Bering Sea", ],
            aes(x = x, y = y, group = stock), color = col.region[["Bering Sea"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(aes(x = x, y = y, color = region), linewidth = 1, alpha=1, 
            na.rm = TRUE) +
  scale_colour_manual(name = "Ocean Region", values=col.region, guide="legend") +
  labs(x = "Percent change in R/S",
       y = "Posterior density",
       color = "") +
  scale_x_continuous(limits = c(-50, 50), expand = c(0, 0)) +
  scale_y_continuous(breaks=NULL) +
  geom_text(data = vars,
            aes(x = -48.1,
                y = max(m.df$y) - 0.008,
                label = lab),
            hjust = 0,
            size = 2.7,
            color = "grey30") +
  facet_wrap( ~ var, ncol = 1) +
  theme_sleek(base_size = 9) +
  theme(legend.justification = c(0, 0),
        legend.position = c(0.83, 0.4),
        legend.key.size = unit(10, "pt"),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        panel.spacing.y = unit(-0.5, "pt"),
        strip.background = element_blank(),
        strip.text.x = element_blank())


```

**Figure 5**. Posterior probability distributions of the predicted effect of SST (top), competitor (pink salmon) abundance (middle), and the combined effect (bottom) on Sockeye productivity (R/S). Faint lines show stock-specific effects while bold lines show regional effects from hierarchical model. X-axis values represent the percent change in productivity per standard deviation unit increase in the covariate.

### Pink

```{r Pink stationary}

# Load model fit
load("../output/models/stat/pink/stat_a.Rdata")

# Get data
lst <- hb05_density_df(stat_a, ocean.regions = 4, info_master=pink.info, data_master=pink)
s.df <- lst$stock
m.df <- lst$region
m.df$region <- factor(m.df$region, levels = c("West Coast", "Gulf of Alaska", "Southeast Alaska", "Bering Sea"))

## Covariate labels
vars <- data.frame(var = levels(m.df$var))
vars$lab <- gsub("Comp", "Competitors", vars$var)
vars$var <- factor(vars$var, levels = c("SST", "Comp", "SST + Comp"))

# I think I could shorten this sometime
ggplot(m.df) +
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_path(data = s.df[s.df$region == "West Coast", ],
            aes(x = x, y = y, group = stock), color = col.region[["West Coast"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Southeast Alaska", ],
            aes(x = x, y = y, group = stock), color = col.region[["Southeast Alaska"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Gulf of Alaska", ],
            aes(x = x, y = y, group = stock), color = col.region[["Gulf of Alaska"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Bering Sea", ],
            aes(x = x, y = y, group = stock), color = col.region[["Bering Sea"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(aes(x = x, y = y, color = region), linewidth = 1, alpha=1, 
            na.rm = TRUE) +
  scale_colour_manual(name = "Ocean Region", values=col.region, guide="legend") +
  labs(x = "Percent change in R/S",
       y = "Posterior density",
       color = "") +
  scale_x_continuous(limits = c(-50, 100), expand = c(0, 0)) +
  scale_y_continuous(breaks=NULL) +
  geom_text(data = vars,
            aes(x = -48.1,
                y = max(m.df$y) - 0.008,
                label = lab),
            hjust = 0,
            size = 2.7,
            color = "grey30") +
  facet_wrap( ~ var, ncol = 1) +
  theme_sleek(base_size = 9) +
  theme(legend.justification = c(0, 0),
        legend.position = c(0.83, 0.4),
        legend.key.size = unit(10, "pt"),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        panel.spacing.y = unit(-0.5, "pt"),
        strip.background = element_blank(),
        strip.text.x = element_blank())
        
```

**Figure 6**. Posterior probability distributions of the predicted effect of SST (top), intra-specific competitor abundance (middle), and the combined effect (bottom) on Pink salmon productivity (R/S). Faint lines show stock-specific effects while bold lines show regional effects from hierarchical model. X-axis values represent the percent change in productivity per standard deviation unit increase in the covariate.

### Chum

```{r Chum stationary}

# Load model fit
load("../output/models/stat/chum/stat_a.Rdata")

chum.info <- chum.info %>% rename(Ocean.Region = Ocean.Region2) # stupid workaround for issues from SEAK region missing.

# Get data
lst <- hb05_density_df(stat_a, ocean.regions = 3, info_master=chum.info, data_master=chum)
s.df <- lst$stock
m.df <- lst$region
m.df$region <- factor(m.df$region, levels = c("West Coast", "Gulf of Alaska", "Southeast Alaska", "Bering Sea"))

## Covariate labels
vars <- data.frame(var = levels(m.df$var))
vars$lab <- gsub("Comp", "Competitors", vars$var)
vars$var <- factor(vars$var, levels = c("SST", "Comp", "SST + Comp"))

# I think I could shorten this sometime
ggplot(m.df) +
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_path(data = s.df[s.df$region == "West Coast", ],
            aes(x = x, y = y, group = stock), color = col.region[["West Coast"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Southeast Alaska", ],
            aes(x = x, y = y, group = stock), color = col.region[["Southeast Alaska"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Gulf of Alaska", ],
            aes(x = x, y = y, group = stock), color = col.region[["Gulf of Alaska"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(data = s.df[s.df$region == "Bering Sea", ],
            aes(x = x, y = y, group = stock), color = col.region[["Bering Sea"]], alpha=0.3,
            na.rm = TRUE) +
  geom_path(aes(x = x, y = y, color = region), linewidth = 1, alpha=1, 
            na.rm = TRUE) +
  scale_colour_manual(name = "Ocean Region", values=col.region, guide="legend") +
  labs(x = "Percent change in R/S",
       y = "Posterior density",
       color = "") +
  scale_x_continuous(limits = c(-50, 50), expand = c(0, 0)) +
  scale_y_continuous(breaks=NULL) +
  geom_text(data = vars,
            aes(x = -48.1,
                y = max(m.df$y) - 0.008,
                label = lab),
            hjust = 0,
            size = 2.7,
            color = "grey30") +
  facet_wrap( ~ var, ncol = 1) +
  theme_sleek(base_size = 9) +
  theme(legend.justification = c(0, 0),
        legend.position = c(0.83, 0.4),
        legend.key.size = unit(10, "pt"),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        panel.spacing.y = unit(-0.5, "pt"),
        strip.background = element_blank(),
        strip.text.x = element_blank())

```

**Figure 7**. Posterior probability distributions of the predicted effect of SST (top), competitor (pink salmon) abundance (middle), and the combined effect (bottom) on Chum salmon productivity (R/S). Faint lines show stock-specific effects while bold lines show regional effects from hierarchical model. X-axis values represent the percent change in productivity per standard deviation unit increase in the covariate.

## Era models {.tabset}

### Sockeye

```{r Sockeye eras}
load("../output/models/dyn/sockeye/hbm_era_2c_3sub.RData")

## Data
# Density dataframe - by stock
dens.df.st.2c <- era_density_df(era.2c.3sub, par=c("gamma", "kappa"), percent.change = T, neras=3, info=sock.info.sub)
dens.df.st.2c <- ocean_region_lab(dens.df.st.2c)
dens.df.st.2c <- era_lab(dens.df.st.2c, data_master=sock.sub, breakpoint2=2011)

# Density dataframe (regional lvl)
dens.df.reg.2c <- era_density_df(era.2c.3sub, par=c("gamma", "kappa"), mu=T, percent.change=T, neras=3, info=sock.info.sub)
dens.df.reg.2c <- ocean_region_lab(dens.df.reg.2c)
dens.df.reg.2c <- era_lab(dens.df.reg.2c, data_master=sock.sub, breakpoint2=2011)



## Figures
ggplot(dens.df.st.2c) + 
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_path(aes(x=x, y=dens, group=stock, col=ocean_region_lab), alpha=0.2) + 
  geom_path(data=dens.df.reg.2c, aes(x=x, y=dens, col=ocean_region_lab), alpha=0.85, linewidth=1) +
  scale_colour_manual(values=col.region) +
  facet_grid(rows=vars(era_lab), cols=vars(factor(varnam, levels=c("SST", "Competitors")))) + 
  coord_cartesian(xlim=c(-50,50)) +
  theme_sleek() + labs(x="Percent change in R/S", y="", col="Ocean Region") +
  theme(axis.text.y=element_blank(),
        legend.key.size = unit(10, "pt"),
        legend.position=c(0.9, 0.2),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        legend.title = element_text(size=9),
        panel.spacing.y = unit(-0.5, "pt"),
        axis.ticks.y=element_blank()) 


```

**Figure 8**. Posterior probability distributions of the predicted effect of SST and competitors on Sockeye productivity over three pre-defined time periods/eras (earliest in top panel). Regional mean effects are shown by bold lines and individual stocks' distributions by light lines.

### Pink

```{r Pink eras}

load("../output/models/dyn/pink/hbm_era_2c.RData")

## Data
# Density dataframe - by stock
dens.df.st.2c <- era_density_df(era.2c, par=c("gamma", "kappa"), percent.change = T, neras=3, info=pink.info)
dens.df.st.2c <- ocean_region_lab(dens.df.st.2c)
dens.df.st.2c <- era_lab(dens.df.st.2c, data_master=pink, breakpoint2=2011)
dens.df.st.2c <- dplyr::filter(dens.df.st.2c, !(Ocean.Region2 %in% c("BS", "GOA") & era=="Late"))

# Density dataframe (regional lvl)
dens.df.reg.2c <- era_density_df(era.2c, par=c("gamma", "kappa"), mu=T, percent.change=T, neras=3, info=pink.info)
dens.df.reg.2c <- ocean_region_lab(dens.df.reg.2c)
dens.df.reg.2c <- era_lab(dens.df.reg.2c, data_master=pink, breakpoint2=2011)
dens.df.reg.2c <- dplyr::filter(dens.df.reg.2c, !(Ocean.Region2 %in% c("BS", "GOA") & era=="Late"))



## Figures
ggplot(dens.df.st.2c) + 
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_path(aes(x=x, y=dens, group=stock, col=ocean_region_lab), alpha=0.2) + 
  geom_path(data=dens.df.reg.2c, aes(x=x, y=dens, col=ocean_region_lab), alpha=0.85, linewidth=1) +
  scale_colour_manual(values=col.region) +
  facet_grid(rows=vars(era_lab), cols=vars(factor(varnam, levels=c("SST", "Competitors")))) + 
  coord_cartesian(xlim=c(-50,100)) +
  theme_sleek() + labs(x="Percent change in R/S", y="", col="Ocean Region") +
  theme(axis.text.y=element_blank(),
        legend.key.size = unit(10, "pt"),
        legend.position=c(0.9, 0.2),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        legend.title = element_text(size=9),
        panel.spacing.y = unit(-0.5, "pt"),
        axis.ticks.y=element_blank()) 

```

**Figure 9**. Posterior probability distributions of the predicted effect of SST and competitors on Pink salmon productivity over three pre-defined time periods/eras (earliest in top panel). Regional mean effects are shown by bold lines and individual stocks' distributions by light lines. Note that data from Alaska for the most recent time period are needed (Figure 3).

### Chum

```{r Chum eras}
load("../output/models/dyn/chum/hbm_era_2c.RData")


## Data
# Density dataframe - by stock
dens.df.st.2c <- era_density_df(era.2c, par=c("gamma", "kappa"), percent.change = T, neras=3, info=chum.info, region.var="Ocean.Region")
dens.df.st.2c <- ocean_region_lab(dens.df.st.2c)
dens.df.st.2c <- era_lab(dens.df.st.2c, data_master=chum, breakpoint2=2011)
dens.df.st.2c <- dplyr::filter(dens.df.st.2c, !(Ocean.Region2 %in% c("BS", "GOA", "SEAK") & era=="Late"))

# Density dataframe (regional lvl)
dens.df.reg.2c <- era_density_df(era.2c, par=c("gamma", "kappa"), mu=T, percent.change=T, neras=3, info=chum.info, region.var="Ocean.Region")
dens.df.reg.2c <- ocean_region_lab(dens.df.reg.2c, var="Ocean.Region")
dens.df.reg.2c <- era_lab(dens.df.reg.2c, data_master=chum, breakpoint2=2011)
dens.df.reg.2c <- dplyr::filter(dens.df.reg.2c, !(Ocean.Region %in% c("BS", "GOA", "SEAK") & era=="Late"))



## Figures
ggplot(dens.df.st.2c) + 
  geom_vline(xintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +
  geom_path(aes(x=x, y=dens, group=stock, col=ocean_region_lab), alpha=0.2) + 
  geom_path(data=dens.df.reg.2c, aes(x=x, y=dens, col=ocean_region_lab), alpha=0.85, linewidth=1) +
  scale_colour_manual(values=col.region) +
  facet_grid(rows=vars(era_lab), cols=vars(factor(varnam, levels=c("SST", "Competitors")))) + 
  coord_cartesian(xlim=c(-50,100)) +
  theme_sleek() + labs(x="Percent change in R/S", y="", col="Ocean Region") +
  theme(axis.text.y=element_blank(),
        legend.key.size = unit(10, "pt"),
        legend.position=c(0.9, 0.2),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        legend.title = element_text(size=9),
        panel.spacing.y = unit(-0.5, "pt"),
        axis.ticks.y=element_blank()) 


```

**Figure 10**. Posterior probability distributions of the predicted effect of SST and competitors on Chum salmon productivity over three pre-defined time periods/eras (earliest in top panel). Regional mean effects are shown by bold lines and individual stocks' distributions by light lines. Note that data from Alaska for the most recent time period are needed, and there are no time series in the Southeast Alaska region.

## Random Walk models {.tabset}

### Sockeye

```{r sockeye random walk, warning=FALSE}
load("../output/models/dyn/sockeye/hbm_dyn_2c_sub.RData")


# Stock specific dataframe
probs <- c(0.025, 0.10, 0.50, 0.90, 0.975)
summ <- rstan::summary(dyn.2c.sub, pars = c("gamma", "kappa"), probs = probs)$summary
df.dyn.st.2c <- data.frame(Stock = sock.sub$Stock,
                   Ocean.Region2 = sock.sub$Ocean.Region2,
                   BY = sock.sub$BY,
                   mu = summ[, "mean"],
                   se = summ[, "se_mean"],
                   lower_10 = summ[, "10%"],
                   upper_90 = summ[ , "90%"],
                   var = str_extract(rownames(summ), "[a-z]+"),
                   varnam = case_when(grepl("^gamma", rownames(summ)) ~ "SST",
                                      grepl("^kappa", rownames(summ)) ~ "Competitors")
                   )
df.dyn.st.2c <- ocean_region_lab(df.dyn.st.2c)

# Summarize at regional lvl
df.dyn.reg.2c <- dplyr::summarize(df.dyn.st.2c, 
                           reg_mean=mean(mu, na.rm=T), 
                           n_stk=n_distinct(Stock),
                           lower_10=quantile(mu, 0.1), 
                           upper_90=quantile(mu, 0.9), 
                           .by=c(Ocean.Region2, BY, varnam))
df.dyn.reg.2c <- ddply(df.dyn.reg.2c, .(Ocean.Region2), dplyr::filter, n_stk >= 4)
df.dyn.reg.2c <- ocean_region_lab(df.dyn.reg.2c)


# Figures
ggplot(df.dyn.reg.2c) +
  geom_hline(yintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +  
  geom_line(data= df.dyn.st.2c, aes(x=BY, y=mu, group=Stock, col=ocean_region_lab), alpha=0.2) +
  geom_line(aes(x=BY, y=reg_mean, col=ocean_region_lab), linewidth=1) +
  #geom_ribbon(aes(x=BY, y=reg_mean, ymin=lower_10, ymax=upper_90, fill=ocean_region_lab), alpha=0.2) +
  facet_grid(cols=vars(factor(ocean_region_lab, levels=rev(levels(ocean_region_lab)))), rows=vars(factor(varnam, levels=c("SST", "Competitors")))) + 
  scale_y_continuous(limits=c(-1, 0.75), breaks=seq(-1,1,0.5)) + 
  scale_colour_manual(values=col.region, aesthetics=c("colour", "fill")) +
  theme_sleek() + theme(legend.position="none") +
   labs(x="Brood Year", y="Mean covariate effects")

# take out the scale squish, and revise 4-stock rule
```

**Figure 11**. Time-varying posterior mean estimates of SST and Competitor covariate effects on Sockeye productivity, modelled as a random walk. Individual stock estimates are in faint lines, while regional means are represented by bolded lines. Region-wide means are post-hoc calculations, rather than resulting from a hierarchical model structure as in the stationary and era models.

### Pink

```{r pink random walk, warning=FALSE}
load("../output/models/dyn/pink/hbm_dyn_2c.RData")

# Stock specific dataframe
probs <- c(0.025, 0.10, 0.50, 0.90, 0.975)
summ <- rstan::summary(dyn.2c, pars = c("gamma", "kappa"), probs = probs)$summary
df.dyn.st.2c <- data.frame(Stock = pink$Stock,
                   Ocean.Region2 = pink$Ocean.Region2,
                   BY = pink$BY,
                   mu = summ[, "mean"],
                   se = summ[, "se_mean"],
                   lower_10 = summ[, "10%"],
                   upper_90 = summ[ , "90%"],
                   var = str_extract(rownames(summ), "[a-z]+"),
                   varnam = case_when(grepl("^gamma", rownames(summ)) ~ "SST",
                                      grepl("^kappa", rownames(summ)) ~ "Competitors"),
                   even_odd = ifelse(grepl("Even$", pink$Stock), "Even", "Odd")
                   )
df.dyn.st.2c <- ocean_region_lab(df.dyn.st.2c)

# Summarize at regional lvl
df.dyn.reg.2c <- dplyr::summarize(df.dyn.st.2c,
                                  reg_mean=mean(mu, na.rm=T), 
                                  n_stk=n_distinct(Stock),
                                  lower_10=quantile(mu, 0.1), 
                                  upper_90=quantile(mu, 0.9), 
                                  .by=c(Ocean.Region2, BY, varnam, even_odd))
df.dyn.reg.2c <- ddply(df.dyn.reg.2c, .(Ocean.Region2), dplyr::filter, n_stk >= 4)
df.dyn.reg.2c <- ocean_region_lab(df.dyn.reg.2c)


# Figures
ggplot(df.dyn.reg.2c) +
  geom_hline(yintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +  
  geom_line(data= df.dyn.st.2c, aes(x=BY, y=mu, group=Stock, col=ocean_region_lab), alpha=0.2) +
  geom_line(aes(x=BY, y=reg_mean, col=ocean_region_lab, linetype=even_odd), linewidth=1) +
  #geom_ribbon(aes(x=BY, y=reg_mean, ymin=lower_10, ymax=upper_90, fill=ocean_region_lab, group=even_odd), alpha=0.2) +
  #geom_line(data=dplyr::filter(df.dyn.st.2c, Ocean.Region2=="WC" & even_odd=="Even"), aes(x=BY, y=mu, group=Stock, col=ocean_region_lab), linetype="twodash", alpha=0.7) +
  facet_grid(cols=vars(factor(ocean_region_lab, levels=rev(levels(ocean_region_lab)))), rows=vars(factor(varnam, levels=c("SST", "Competitors")))) + 
  scale_linetype_manual(values=c("Odd" = "solid", "Even" = "twodash")) +
  scale_y_continuous(limits=c(-1,1.5), breaks=seq(-1,1.5,0.5)) + 
  scale_colour_manual(values=col.region, aesthetics=c("colour", "fill")) +
  theme_sleek() + theme(legend.position="none") +
   labs(x="Brood Year", y="Mean covariate effects")

```

**Figure 12**. Time-varying posterior mean estimates of SST and Competitor covariate effects on Pink salmon productivity, modelled as a random walk. Individual stock estimates are in faint lines, while regional means are represented by bold lines. Solid bold lines represent odd-year Pink stocks, while dashed lines are even-year stocks. Region-wide means are post-hoc calculations, rather than resulting from a hierarchical model structure as in the stationary and era models.

### Chum

```{r chum random walk, warning=FALSE}
load("../output/models/dyn/chum/hbm_dyn_2c.RData")


# Stock specific dataframe
probs <- c(0.025, 0.10, 0.50, 0.90, 0.975)
summ <- rstan::summary(dyn.2c, pars = c("gamma", "kappa"), probs = probs)$summary
df.dyn.st.2c <- data.frame(Stock = chum$Stock,
                   Ocean.Region2 = chum$Ocean.Region2,
                   BY = chum$BY,
                   mu = summ[, "mean"],
                   se = summ[, "se_mean"],
                   lower_10 = summ[, "10%"],
                   upper_90 = summ[ , "90%"],
                   var = str_extract(rownames(summ), "[a-z]+"),
                   varnam = case_when(grepl("^gamma", rownames(summ)) ~ "SST",
                                      grepl("^kappa", rownames(summ)) ~ "Competitors")
                   )
df.dyn.st.2c <- ocean_region_lab(df.dyn.st.2c)

# Summarize at regional lvl
df.dyn.reg.2c <- dplyr::summarize(df.dyn.st.2c, 
                           reg_mean=mean(mu, na.rm=T), 
                           n_stk=n_distinct(Stock),
                           lower_10=quantile(mu, 0.1), 
                           upper_90=quantile(mu, 0.9), 
                           .by=c(Ocean.Region2, BY, varnam))
df.dyn.reg.2c <- ddply(df.dyn.reg.2c, .(Ocean.Region2), dplyr::filter, n_stk >= 4)
df.dyn.reg.2c <- ocean_region_lab(df.dyn.reg.2c)


# Figures
ggplot(df.dyn.reg.2c[df.dyn.reg.2c$Ocean.Region2 != "SEAK",]) +
  geom_hline(yintercept = 0, color = "grey50", linetype = 2, linewidth = 0.25) +  
  geom_line(data= df.dyn.st.2c, aes(x=BY, y=mu, group=Stock, col=ocean_region_lab), alpha=0.2) +
  geom_line(aes(x=BY, y=reg_mean, col=ocean_region_lab), linewidth=1) +
  #geom_ribbon(aes(x=BY, y=reg_mean, ymin=lower_10, ymax=upper_90, fill=ocean_region_lab), alpha=0.2) +
  facet_grid(cols=vars(factor(ocean_region_lab, levels=rev(levels(ocean_region_lab)))), rows=vars(factor(varnam, levels=c("SST", "Competitors")))) + 
  scale_y_continuous(limits=c(-1, 0.75), breaks=seq(-1,1,0.5)) + 
  scale_colour_manual(values=col.region, aesthetics=c("colour", "fill")) +
  theme_sleek() + theme(legend.position="none") +
   labs(x="Brood Year", y="Mean covariate effects")


```

**Figure 13**. Time-varying posterior mean estimates of SST and Competitor covariate effects on Chum salmon productivity, modelled as a random walk. Individual stock estimates are in faint lines, while regional means are represented by bolded lines. Region-wide means are post-hoc calculations, rather than resulting from a hierarchical model structure as in the stationary and era models.

# Next steps

Priorities for future analyses include:

1.  Updating data to present (as recent as possible) for all species and regions, particularly Alaskan pink and chum.

2.  Sensitivity analyses of SST and competitor index covariates.

    -   *SST*: The resolution of the SST data is currently 2 x 2 degrees ([ERSST](https://www.ncei.noaa.gov/products/extended-reconstructed-sst)). Cells within 400 km of ocean entry points are averaged over the three months after migration to sea (April-September, depending on ocean region according to [Mueter et al. 2002](dx.doi.org/10.1139/f02-020)). Given that these assumptions about the spatial and temporal window over which SST is averaged are quite dated, sensitivity to these assumptions will be tested with alternative spatial and temporal windows. However, we will continue to focus on early marine life to remain consistent with the overall hypothesis that juvenile salmon are impacted by temperature in the first year of marine life, and fine-scale analyses of local SST conditions are outside the scope of this project. That said there may be high-resolution SST data available in the near future to further explore this in subsequent paper.

    -   *Competitor Index*: Our base cases analysis focuses on the abundance of pink salmon across the North Pacific in the second and/or third years of marine life as an index of potential direct or indirect competition for food. This approach is consistent with research that has suggested some salmon species primarily exhibit responses to competition with pink salmon during their second and/or third growing seasons at sea ([Connors et al. 2020](https://cdnsciencepub.com/doi/full/10.1139/cjfas-2019-0422); [Ruggerone et al.2023](https://www.int-res.com/articles/feature/m719p001.pdf)). However, we also plan to fit models to a small subset of alternative competitor indices as part of sensitivity analysis for this paper (e.g., total pink, chum and sockeye abundance; just North American abundances, biomass instead of abundance, etc.) and have begun sketching out a more comprehensive analytical plan for a separate paper that explores evidence for a wider range of hypotheses about intra- and inter-specific interactions at a variety of spatial and temporal scales.

3.  Revising hierachical grouping of Pink salmon stocks. The random walk models for Pink salmon show the trends for even-year and odd-year stocks separately for ease of visualization, but the difference in the effects between lineages in some cases begs the question of whether even and odd stocks within a region should be grouped together or separately in hierarchical models. We will investigate the possibility of separating them, which is consistent with the hypothesis that the genetically distinct odd- and even-year lineages of Pink salmon may respond differently to ocean warming ([Irvine et al. 2014](%5BIncreasing%20Dominance%20of%20Odd‐Year%20Returning%20Pink%20Salmon%5D(https://afspubs.onlinelibrary.wiley.com/doi/pdfdirect/10.1080/00028487.2014.889747))).

4.  Random Walk model improvements. Work on versions of random walk models with (1) estimated region-wide mean effects, and (2) reduced sensitivity to time series of different lengths, is ongoing.
